name: Test Performance With K6

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  backend-compose:
    runs-on: ubuntu-latest # he dieu hanh

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3 #clone repo

      - name: Set up Docker Buildx # cai docker
        uses: docker/setup-buildx-action@v3

      - name: Stop & remove old containers
        run: | #xoa docker cu neu co
          cd FloginFE_BE/backend
          docker compose down --remove-orphans

      - name: Build and start backend + MySQL #--no-cache lan nao cung cai image tu dockerfile ==> container (khong sai container cu)
        run: | #chay docker do backend da co dockerfile nen no chi can tim thay dockerfile la cai dc ca MySQL lan backend
          cd FloginFE_BE/backend 
          docker compose build --no-cache #
          docker compose up -d

      - name: Setup k6 # cai k6
        uses: grafana/setup-k6-action@v1

      - name: Run Login Test
        run: | #chay test login
          cd FloginFE_BE/k6-tests
          k6 run scripts/login-tests.js

      - name: Run Product Test
        run: | #chay test product
          cd FloginFE_BE/k6-tests
          k6 run scripts/product-tests.js

      - name: Stress Test End Point Get All Product
        run: | #chay stress test
          cd FloginFE_BE/k6-tests
          k6 run scripts/stress-tests.js

      - name: Upload tests results
        uses: actions/upload-artifact@v4
        if: always() #luon chay neu ben tren tra ve exit 1
        with:
          name: k6-results
          path: |
            FloginFE_BE/k6-tests/results/
          retention-days: 7 #luu tru trong 7 ngay

      - name: Stop containers
        if: always() #luon chay
        run: |
          cd FloginFE_BE/backend
          docker compose down